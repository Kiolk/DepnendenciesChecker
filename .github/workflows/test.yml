name: Check Dependency Changes

on:
  pull_request:
    branches:
      - develop
    paths:
      - 'gradle/libs.versions.toml'

jobs:
  check-dependencies:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch develop branch
        run: git fetch origin develop:develop

      - name: Check for changes in libs.versions.toml
        id: check_changes
        run: |
          if git diff --quiet origin/develop HEAD -- gradle/libs.versions.toml; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes in libs.versions.toml"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in libs.versions.toml"
          fi

      - name: Comment on changed dependency lines
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const confluenceLink = 'https://your-company.atlassian.net/wiki/spaces/DEV/pages/123456789/Dependencies';
            
            // Dependencies to skip (add more as needed)
            const skipDependencies = [
              'gmal-kmm',
              'test-dependency',
            ];
            
            // Get the files changed in this PR
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const versionFile = files.find(f => f.filename === 'gradle/libs.versions.toml');
            
            if (!versionFile || !versionFile.patch) {
              console.log('No changes found in gradle/libs.versions.toml');
              return;
            }
            
            console.log('Processing changes in libs.versions.toml...');
            
            // Parse the patch to find changed lines
            const lines = versionFile.patch.split('\n');
            let currentLine = 0;
            const changedLines = [];
            
            for (const line of lines) {
              if (line.startsWith('@@')) {
                // Extract the starting line number from the diff header
                const match = line.match(/@@ -\d+,?\d* \+(\d+)/);
                currentLine = match ? parseInt(match[1]) : 0;
              } else if (line.startsWith('+') && !line.startsWith('+++')) {
                // This is an added line
                const content = line.substring(1).trim();
                
                // Check if this line should be skipped
                const shouldSkip = skipDependencies.some(dep => content.includes(dep));
                
                if (shouldSkip) {
                  console.log(`â­ï¸ Skipping line ${currentLine}: ${content}`);
                } else {
                  changedLines.push({ lineNumber: currentLine, content });
                  console.log(`âœ“ Will comment on line ${currentLine}: ${content}`);
                }
                
                currentLine++;
              } else if (!line.startsWith('-')) {
                // Context line or unchanged line
                currentLine++;
              }
            }
            
            if (changedLines.length === 0) {
              console.log('No relevant dependency changes found (all changes are in skip list)');
              
              // Post info comment that all changes are skipped
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## ğŸ“š Dependency Check
                
                â„¹ï¸ Changes detected in \`libs.versions.toml\`, but all modified dependencies are in the skip list.
                
                No documentation updates required.`
              });
              
              return;
            }
            
            console.log(`Found ${changedLines.length} dependency changes to comment on`);
            
            let successCount = 0;
            let failCount = 0;
            
            // Post comments on each changed line
            for (const change of changedLines) {
              try {
                await github.rest.pulls.createReviewComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.issue.number,
                  body: `ğŸ“š **Documentation Update Required**
            
            ğŸ”„ A dependency version has been changed on this line.
            
            ### Action Items:
            
            1. âœï¸ Update the new version in [Confluence](${confluenceLink})
            2. âœ… Add a comment below confirming the documentation has been updated
            3. âœ”ï¸ Resolve this thread
            
            ---
            
            ğŸ’¡ _Keeping our documentation up-to-date helps the entire team stay informed about dependency changes._`,
                  commit_id: context.payload.pull_request.head.sha,
                  path: 'gradle/libs.versions.toml',
                  line: change.lineNumber,
                  side: 'RIGHT'
                });
                successCount++;
                console.log(`âœ… Posted comment on line ${change.lineNumber}`);
              } catch (error) {
                failCount++;
                console.error(`âŒ Failed to comment on line ${change.lineNumber}: ${error.message}`);
              }
            }
            
            // Post a summary comment on the PR
            const summaryEmoji = failCount === 0 ? 'âœ…' : 'âš ï¸';
            const summaryText = failCount === 0 
              ? 'All inline comments posted successfully!' 
              : `Posted ${successCount} comments, ${failCount} failed.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ğŸ“š Dependency Documentation Check
            
            ${summaryEmoji} **${summaryText}**
            
            ğŸ” Changes detected in \`libs.versions.toml\` - ${changedLines.length} dependency ${changedLines.length === 1 ? 'change' : 'changes'} requiring documentation updates.
            
            ### What to do:
            
            1. ğŸ“ Review each inline comment on the changed lines
            2. ğŸ”— Update the documentation in [Confluence](${confluenceLink})
            3. âœ… Reply to each comment confirming the update
            4. âœ”ï¸ Resolve the threads once complete
            
            ---
            
            _Thank you for keeping our documentation up-to-date! ğŸ™_`
            });
            
            console.log('âœ… Posted summary comment on PR');
